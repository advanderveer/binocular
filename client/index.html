<html>
  <head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,300,500' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>
  	<h1>
  		<a target="_blank" href="http://dockpit.io" class="lighter">dockpit.io</a>/<a target="_blank" href="http://github.com/dockpit/binocular">binocular</a>
  	</h1>
  	<h2>microservice overview</h2>
    <div id="viz"></div>
    <script>


function name(d) { return d.name; }
function group(d) { return d.group; }

var color = d3.scale.category10();
function colorByGroup(d) { return color(group(d)); }

//use full screen
width = window.innerWidth, height = window.innerHeight;

var svg = d3.select('#viz').append('svg')

var node, link;

var voronoi = d3.geom.voronoi()
    .x(function(d) { return d.x; })
    .y(function(d) { return d.y; })
    .clipExtent([[-10, -10], [width+10, height+10]]);

function recenterVoronoi(nodes) {
    var shapes = [];
    voronoi(nodes).forEach(function(d) {
        if ( !d.length ) return;
        var n = [];
        d.forEach(function(c){
            n.push([ c[0] - d.point.x, c[1] - d.point.y ]);
        });
        n.point = d.point;
        shapes.push(n);
    });
    return shapes;
}

var force = d3.layout.force()
    .charge(-2000)
    .friction(0.3)
    .linkDistance(50)
    .size([width, height]);

// -> Resizing logic
function resize() {
  width = window.innerWidth, height = window.innerHeight;
  svg.attr("width", width).attr("height", height);
  force.size([width, height]).resume();
  voronoi.clipExtent([[-10, -10], [width+10, height+10]]);
}

d3.select(window).on("resize", resize);
// -> Resizing logic end

force.on('tick', function() {
    node.attr('transform', function(d) { return 'translate('+d.x+','+d.y+')'; })
        .attr('clip-path', function(d) { return 'url(#clip-'+d.index+')'; });

    link.attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });

    var clip = svg.selectAll('.clip')
        .data( recenterVoronoi(node.data()), function(d) { return d.point.index; } );

    clip.enter().append('clipPath')
        .attr('id', function(d) { return 'clip-'+d.point.index; })
        .attr('class', 'clip');
    clip.exit().remove()

    clip.selectAll('path').remove();
    clip.append('path')
        .attr('d', function(d) { return 'M'+d.join(',')+'Z'; });
});

d3.json('test_data.json', function(err, raw) {

		//prepare final data container
		var nodes = []
		var links = []
		var data = {nodes: nodes, links: links}

		//add container name to nodes if not yet exists
		var upsertNode = function(name){
			var n = nodes.filter(function(n){
				return n.name === name
			})

			if(n.length === 0) {
				nodes.push({name: name, group: nodes.length})
			}
		}

		//get an index of a node by name
		var indexOfNode = function(name) {
			var idx = 0
			nodes.forEach(function(n){
				if(n.name === name) {
					idx = nodes.indexOf(n)
					return
				}
			})

			return idx
		}

		//add container name to nodes if not yet exists
		var upsertLink = function(fromIdx, toIdx){
			var existing = links.filter(function(l){
				return l.source === fromIdx && l.target === toIdx
			})

			if(existing.length == 0) {
				links.push({source: fromIdx, target: toIdx, value: 1})
			} else {
				//increment value
				existing.forEach(function(ex){
					ex.value++
				})
			}
		}

		//raw to data
		raw.forEach(function(l){
			upsertNode(l.From)
			upsertNode(l.To)

			var fromIdx = indexOfNode(l.From)
			var toIdx = indexOfNode(l.To)

			upsertLink(fromIdx, toIdx)
		})

    data.nodes.forEach(function(d, i) {
        d.id = i;
    });

    //create links
    link = svg.selectAll('.link')
        .data( data.links )
     		.enter().append('line')
        .attr('class', 'link')
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

    //create nodes
    node = svg.selectAll('.node')
        .data( data.nodes )
      	.enter().append('g')
        .attr('title', name)
        .attr('class', 'node')
        .call( force.drag );

    //selection circle
    node.append('circle')
        .attr('r', 30)
        .attr('fill', "#CCC")
        .attr('fill-opacity', 0.5);

    //node dots
    node.append('circle')
        .attr('r', 4)
        .attr('stroke', 'black');

    //label
		node.append("text")
		    .attr("x", 12)
		    .attr("dy", ".35em")
		    .text(function(d) { return d.name.substring(0, 5); });

    force
        .nodes( data.nodes )
        .links( data.links )
        .start();

    resize();
});

    </script>
  </body>
</html>